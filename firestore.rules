rules_version = '2';

// QuizForge Firestore Security Rules
// These rules enforce access control at the database level
// Last updated: January 2026

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper Functions
    // =========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Extract userId from document ID pattern: quizforge-account-{userId}
    function getUserIdFromAccountDoc(docId) {
      return docId.replace('quizforge-account-', '');
    }

    // Extract userId from document ID pattern: quizforge-data-{userId}
    function getUserIdFromDataDoc(docId) {
      return docId.replace('quizforge-data-', '');
    }

    // =========================================================================
    // User Data Rules
    // =========================================================================

    // Shared quiz documents (public) - stored as userData/shared-{id}
    match /userData/{docId} {
      // Shared quizzes are public (anyone can read without auth)
      allow read: if docId.matches('shared-.*') ||
        (isAuthenticated() && (
          (docId.matches('quizforge-account-.*') &&
           request.auth.uid == getUserIdFromAccountDoc(docId)) ||
          (docId.matches('quizforge-data-.*') &&
           request.auth.uid == getUserIdFromDataDoc(docId))
        ));

      // Shared quiz create: authenticated users only
      // Shared quiz update: authenticated users (for leaderboard/timesTaken)
      // Other docs: owner only
      allow create: if isAuthenticated() && (
        docId.matches('shared-.*') ||
        (docId.matches('quizforge-account-.*') &&
         request.auth.uid == getUserIdFromAccountDoc(docId)) ||
        (docId.matches('quizforge-data-.*') &&
         request.auth.uid == getUserIdFromDataDoc(docId))
      );

      allow update: if isAuthenticated() && (
        docId.matches('shared-.*') ||
        (docId.matches('quizforge-account-.*') &&
         request.auth.uid == getUserIdFromAccountDoc(docId)) ||
        (docId.matches('quizforge-data-.*') &&
         request.auth.uid == getUserIdFromDataDoc(docId))
      );

      // Delete: owner only (shared quizzes check sharedBy field)
      allow delete: if isAuthenticated() && (
        (docId.matches('shared-.*') && resource.data.sharedBy == request.auth.uid) ||
        (docId.matches('quizforge-account-.*') &&
         request.auth.uid == getUserIdFromAccountDoc(docId)) ||
        (docId.matches('quizforge-data-.*') &&
         request.auth.uid == getUserIdFromDataDoc(docId))
      );

      // Subcollections under userData documents
      match /{subcollection}/{subDoc} {
        allow read, write: if isAuthenticated() && (
          (docId.matches('quizforge-account-.*') &&
           request.auth.uid == getUserIdFromAccountDoc(docId)) ||
          (docId.matches('quizforge-data-.*') &&
           request.auth.uid == getUserIdFromDataDoc(docId))
        );
      }
    }

    // =========================================================================
    // Class Rules
    // =========================================================================

    match /classes/{classId} {
      // Anyone authenticated can read classes (needed for join by code)
      allow read: if isAuthenticated();

      // Only the teacher who created the class can write
      allow create: if isAuthenticated() &&
                      request.resource.data.teacherId == request.auth.uid;

      allow update: if isAuthenticated() && (
        // Teacher can update their own class
        resource.data.teacherId == request.auth.uid ||
        // Students can only update the students array to add/remove themselves
        (resource.data.students != null &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['students']) &&
         (
           // Adding self to students
           request.resource.data.students.hasAll([request.auth.uid]) ||
           // Removing self from students
           !request.resource.data.students.hasAny([request.auth.uid])
         ))
      );

      allow delete: if isAuthenticated() &&
                      resource.data.teacherId == request.auth.uid;
    }

    // =========================================================================
    // Assignment Rules
    // =========================================================================

    match /assignments/{assignmentId} {
      // SECURITY: Only allow reading assignments if user is:
      // 1. The teacher who created it, OR
      // 2. A student enrolled in the assignment's class
      // We store classId in the assignment and check class membership
      allow read: if isAuthenticated() && (
        // Teacher who created this assignment
        resource.data.teacherId == request.auth.uid ||
        // Student enrolled in the class - check if class document has this user in students array
        (resource.data.classId != null &&
         exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
         request.auth.uid in get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.students)
      );

      // Only the teacher can create/update/delete their assignments
      allow create: if isAuthenticated() &&
                      request.resource.data.teacherId == request.auth.uid;

      allow update, delete: if isAuthenticated() &&
                              resource.data.teacherId == request.auth.uid;
    }

    // =========================================================================
    // Submission Rules
    // =========================================================================

    match /submissions/{submissionId} {
      // SECURITY: Use ONLY studentId (uid) for identity verification
      // Email-based checks removed to prevent spoofing attacks

      // Students can read their own submissions
      // Teachers can read submissions for assignments they created
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        // Allow teacher to read submissions for their assignments
        (resource.data.assignmentId != null &&
         exists(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)) &&
         get(/databases/$(database)/documents/assignments/$(resource.data.assignmentId)).data.teacherId == request.auth.uid)
      );

      // SECURITY: Students can ONLY create submissions with their own uid
      // The studentEmail field is informational only - not used for auth
      allow create: if isAuthenticated() &&
        request.resource.data.studentId == request.auth.uid;

      // Students can update their own submissions (for retakes)
      allow update: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;

      // Only allow delete by the student who created it
      allow delete: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;
    }

    // =========================================================================
    // Organization Rules
    // =========================================================================

    match /organizations/{orgId} {
      // Members can read organization data
      allow read: if isAuthenticated() && (
        resource.data.adminUserId == request.auth.uid ||
        isMemberOfOrg(orgId)
      );

      // Only admins can update organization settings
      allow update: if isAuthenticated() &&
                      resource.data.adminUserId == request.auth.uid;

      // Anyone can create an organization (they become admin)
      allow create: if isAuthenticated() &&
                      request.resource.data.adminUserId == request.auth.uid;

      // Only admin can delete
      allow delete: if isAuthenticated() &&
                      resource.data.adminUserId == request.auth.uid;

      // Organization members subcollection
      // SECURITY: Members can only be added through the server-side API (admin SDK)
      // which validates that the user is a teacher before allowing them to join
      match /members/{memberId} {
        // Members can read the member list
        allow read: if isAuthenticated() && (
          isMemberOfOrg(orgId) ||
          get(/databases/$(database)/documents/organizations/$(orgId)).data.adminUserId == request.auth.uid
        );

        // Admin can add/update/remove members
        allow write: if isAuthenticated() &&
                       get(/databases/$(database)/documents/organizations/$(orgId)).data.adminUserId == request.auth.uid;

        // Users can update their own membership status (e.g., leave the org)
        // But cannot change their role or other sensitive fields
        allow update: if isAuthenticated() &&
                        memberId == request.auth.uid &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);
      }

      // Shared quizzes subcollection
      match /sharedQuizzes/{quizId} {
        // Members can read shared quizzes
        allow read: if isAuthenticated() && isMemberOfOrg(orgId);

        // Members can create shared quizzes
        allow create: if isAuthenticated() &&
                        isMemberOfOrg(orgId) &&
                        request.resource.data.sharedBy == request.auth.uid;

        // Owner or admin can update/delete
        allow update, delete: if isAuthenticated() && (
          resource.data.sharedBy == request.auth.uid ||
          get(/databases/$(database)/documents/organizations/$(orgId)).data.adminUserId == request.auth.uid
        );
      }
    }

    // Helper to check org membership
    function isMemberOfOrg(orgId) {
      return exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.status == 'active';
    }

    // =========================================================================
    // Notifications Rules
    // =========================================================================

    match /notifications/{notificationId} {
      // SECURITY: Use recipientUserId for identity verification (not email)
      // Users can only read their own notifications
      allow read: if isAuthenticated() &&
                    resource.data.recipientUserId == request.auth.uid;

      // Teachers can create notifications for students
      allow create: if isAuthenticated();

      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() &&
                      resource.data.recipientUserId == request.auth.uid;

      // Users can delete their own notifications
      allow delete: if isAuthenticated() &&
                      resource.data.recipientUserId == request.auth.uid;
    }

    // =========================================================================
    // Default Deny
    // =========================================================================

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
